# Action that is used for PRs to main branch
# It installs pester and runs the pester tests only

name: CI

on:
  pull_request:
    branches: [ main ]
    
env:
    PACKAGE_PREFIX: 1
    OCTOPUS_PACKAGE_NAME: "EnthisuasticPromotions"
    OCTOPUS_SPACE_NAME: "Octopus Server"
    OCTOPUS_PROJECT_NAME: "Octopus Server"
    OCTOPUS_ENTHUSIASTIC_PROMOTIONS_RUNBOOK_NAME: "Enthusiastic Promotions"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        
      - name: Install Pester
        id: install-pester
        run: Install-Module "Pester" -Force
        shell: pwsh
       
      - name: Run Pester Tests
        id: pester-tests
        run: |
          Import-Module -Name "Pester"
          $configuration = [PesterConfiguration]::Default
          $configuration.Run.Exit = $true
          Invoke-Pester -configuration $configuration
        shell: pwsh

      - name: Publish Runbook
        run: ./Build/UpdateRunbook.ps1 -octopusURL "${{ secrets.OCTOPUS_SERVER }}" -octopusAPIKey "${{ secrets.OCTOPUS_APIKEY }}" -spaceName "$OCTOPUS_SPACE_NAME" -projectName "$OCTOPUS_PROJECT_NAME" -runbookName "$OCTOPUS_ENTHUSIASTIC_PROMOTIONS_RUNBOOK_NAME"
        shell: pwsh